<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C&M - Controle de Consultor (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --cor-laranja: #F5A623;
            --cor-verde: #C8D946;
            --cor-turquesa: #4ECDC4;
            --cor-escuro: #2C5F5D;
        }
        .bg-cm-escuro { background-color: var(--cor-escuro); }
        .bg-cm-laranja { background-color: var(--cor-laranja); }
        .bg-cm-verde { background-color: var(--cor-verde); }
        .bg-cm-turquesa { background-color: var(--cor-turquesa); }
        .text-cm-escuro { color: var(--cor-escuro); }
        .text-cm-laranja { color: var(--cor-laranja); }
        .text-cm-verde { color: var(--cor-verde); }
        .text-cm-turquesa { color: var(--cor-turquesa); }
        .btn-cm { background: linear-gradient(135deg, var(--cor-laranja), var(--cor-verde), var(--cor-turquesa)); }
        .btn-cm:hover { opacity: 0.9; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }
        .loading.active { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Spinner -->
    <div id="loading" class="loading">
        <div class="bg-white p-8 rounded-lg shadow-2xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-cm-turquesa border-solid"></div>
            <p class="mt-4 text-cm-escuro font-semibold">Carregando...</p>
        </div>
    </div>

    <div id="app"></div>

    <script>
        // ========================================
        // üî• CONFIGURA√á√ÉO DO SUPABASE
        // ========================================
        // PASSO 1: V√° no Supabase ‚Üí Settings ‚Üí API
        // PASSO 2: Copie a "Project URL" e cole abaixo entre as aspas
        // PASSO 3: Copie a "anon/public key" e cole abaixo entre as aspas
        
      const SUPABASE_URL = 'https://awppfluuudipkgrtrgyw.supabase.co';  // ‚Üê COM ASPAS!
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3cHBmbHV1dWRpcGtncnRyZ3l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTk5MDYsImV4cCI6MjA4NTM5NTkwNn0.L7EjW4ytXMbVlGxhsMb8Hh77cjRpPr5Y-KG0dR4e35A';  // ‚Üê COM ASPAS!
        // ========================================
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        class ControlConsultor {
            constructor() {
                this.currentUser = null;
                this.currentPage = 'desempenho';
                this.vendas = [];
                this.comissaoPadrao = 5;
                this.filtroDataInicio = this.getDataMesAtual();
                this.filtroDataFim = this.getDataAtual();
                this.editingId = null;
                this.historicoDesempenho = [];
                this.rotinaTrabalho = [];
                this.editingRotinaId = null;
                
                this.verificarSessao();
            }

            async verificarSessao() {
                this.showLoading();
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    this.currentUser = session.user;
                    await this.carregarDados();
                    this.render();
                } else {
                    this.renderLogin();
                }
                this.hideLoading();
            }

            showLoading() {
                document.getElementById('loading').classList.add('active');
            }

            hideLoading() {
                document.getElementById('loading').classList.remove('active');
            }

            getDataAtual() {
                return new Date().toISOString().split('T')[0];
            }

            getDataMesAtual() {
                const hoje = new Date();
                const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                return primeiroDia.toISOString().split('T')[0];
            }

            async carregarDados() {
                this.showLoading();
                
                // Carregar vendas
                const { data: vendas } = await supabase
                    .from('vendas')
                    .select('*')
                    .eq('user_id', this.currentUser.id)
                    .order('created_at', { ascending: false });
                this.vendas = vendas || [];

                // Carregar rotina
                const { data: rotina } = await supabase
                    .from('rotina_trabalho')
                    .select('*')
                    .eq('user_id', this.currentUser.id)
                    .order('ordem', { ascending: true });
                
                if (rotina && rotina.length > 0) {
                    this.rotinaTrabalho = rotina.map(r => ({
                        id: r.id,
                        horario: r.horario,
                        etiqueta: r.etiqueta,
                        cor: r.cor,
                        tarefas: r.tarefas,
                        completo: false
                    }));
                } else {
                    // Criar rotina padr√£o se n√£o existir
                    await this.criarRotinaPadrao();
                }

                // Carregar hist√≥rico
                const { data: historico } = await supabase
                    .from('historico_desempenho')
                    .select('*')
                    .eq('user_id', this.currentUser.id)
                    .order('data', { ascending: false });
                this.historicoDesempenho = historico || [];

                // Carregar configura√ß√µes
                const { data: config } = await supabase
                    .from('configuracoes')
                    .select('*')
                    .eq('user_id', this.currentUser.id)
                    .single();
                
                if (config) {
                    this.comissaoPadrao = parseFloat(config.comissao_padrao);
                }

                this.hideLoading();
            }

            async criarRotinaPadrao() {
                const rotinaPadrao = [
                    { ordem: 1, horario: '08:00 √†s 08:30', etiqueta: 'Novo Cliente', cor: 'bg-green-500', tarefas: ['Chamar TODOS novos clientes do LL', 'Verificar etiqueta novo cliente', 'Etiquetar conforme o fluxo de etiquetas'] },
                    { ordem: 2, horario: '08:30 √†s 11:00', etiqueta: 'Atendimento', cor: 'bg-blue-500', tarefas: ['Interagir com TODOS os clientes', 'Etiquetar conforme o fluxo de etiquetas'] },
                    { ordem: 3, horario: '11:00 √†s 12:00', etiqueta: 'Aguardando Pagamento', cor: 'bg-red-500', tarefas: ['Lembrar fechamento cobrar leve', 'Follow-up em atendimento'] },
                    { ordem: 4, horario: '12:00 √†s 13:30', etiqueta: 'Almo√ßo', cor: 'bg-green-600', tarefas: ['Intervalo para almo√ßo'] },
                    { ordem: 5, horario: '13:30 √†s 14:00', etiqueta: 'N√£o Responde', cor: 'bg-yellow-500', tarefas: ['Prospectar 25 clientes antigos'] },
                    { ordem: 6, horario: '14:00 √†s 16:00', etiqueta: 'Atendimento', cor: 'bg-blue-500', tarefas: ['Interagir com TODOS os clientes', 'Finalizar TODOS or√ßamentos da etiqueta', 'Etiquetar conforme o fluxo de etiquetas'] },
                    { ordem: 7, horario: '16:00 √†s 16:30', etiqueta: 'Analisando', cor: 'bg-yellow-500', tarefas: ['Prospectar 25 clientes antigos'] },
                    { ordem: 8, horario: '16:30 √†s 18:00', etiqueta: 'Aguardando Pagamento', cor: 'bg-red-500', tarefas: ['Buscar fechamento com TODOS da etiqueta', 'Conferir se contatos do dia tem etiqueta', 'Lan√ßar vendas do dia no LL'] }
                ];

                for (const item of rotinaPadrao) {
                    await supabase.from('rotina_trabalho').insert({
                        user_id: this.currentUser.id,
                        ordem: item.ordem,
                        horario: item.horario,
                        etiqueta: item.etiqueta,
                        cor: item.cor,
                        tarefas: item.tarefas
                    });
                }

                await this.carregarDados();
            }

            async registrarUsuario(nome, email, senha) {
                this.showLoading();
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: senha,
                    options: {
                        data: {
                            nome: nome
                        }
                    }
                });

                this.hideLoading();

                if (error) {
                    alert('Erro ao criar conta: ' + error.message);
                    return;
                }

                alert('‚úÖ Conta criada com sucesso! Verifique seu email para confirmar.');
                this.renderLogin();
            }

            async fazerLogin(email, senha) {
                this.showLoading();
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: senha
                });

                this.hideLoading();

                if (error) {
                    alert('Erro ao fazer login: ' + error.message);
                    return;
                }

                this.currentUser = data.user;
                await this.carregarDados();
                this.render();
            }

            async logout() {
                await supabase.auth.signOut();
                this.currentUser = null;
                this.renderLogin();
            }

            toggleTarefaCompleta(id) {
                const item = this.rotinaTrabalho.find(r => r.id === id);
                if (item) {
                    item.completo = !item.completo;
                    this.render();
                }
            }

            async salvarDiaNoHistorico() {
                const hoje = this.getDataAtual();
                const tarefasCompletas = this.rotinaTrabalho.filter(t => t.completo).length;
                const totalTarefas = this.rotinaTrabalho.length;
                const percentual = Math.round((tarefasCompletas / totalTarefas) * 100);

                this.showLoading();

                // Deletar registro do mesmo dia se existir
                await supabase
                    .from('historico_desempenho')
                    .delete()
                    .eq('user_id', this.currentUser.id)
                    .eq('data', hoje);

                // Inserir novo registro
                const { error } = await supabase
                    .from('historico_desempenho')
                    .insert({
                        user_id: this.currentUser.id,
                        data: hoje,
                        tarefas_completas: tarefasCompletas,
                        total_tarefas: totalTarefas,
                        percentual: percentual,
                        detalhes: this.rotinaTrabalho.map(r => ({
                            etiqueta: r.etiqueta,
                            completo: r.completo
                        }))
                    });

                await this.carregarDados();
                this.hideLoading();

                if (!error) {
                    alert(`‚úÖ Dia registrado! Voc√™ completou ${percentual}% das tarefas hoje.`);
                }
            }

            resetarRotina() {
                if (confirm('Deseja resetar todas as tarefas da rotina?')) {
                    this.rotinaTrabalho.forEach(item => item.completo = false);
                    alert('Rotina resetada com sucesso!');
                    this.render();
                }
            }

            abrirModalEditarRotina(id) {
                this.editingRotinaId = id;
                this.render();
                setTimeout(() => {
                    document.getElementById('modalEditarRotina').classList.add('active');
                }, 100);
            }

            fecharModalEditarRotina() {
                this.editingRotinaId = null;
                document.getElementById('modalEditarRotina')?.classList.remove('active');
            }

            async salvarEdicaoRotina() {
                const item = this.rotinaTrabalho.find(r => r.id === this.editingRotinaId);
                if (!item) return;

                const horario = document.getElementById('editHorario')?.value || '';
                const etiqueta = document.getElementById('editEtiqueta')?.value || '';
                const cor = document.getElementById('editCor')?.value || 'bg-blue-500';
                const tarefasText = document.getElementById('editTarefas')?.value || '';
                const tarefas = tarefasText.split('\n').filter(t => t.trim());

                if (!horario || !etiqueta || tarefas.length === 0) {
                    alert('Preencha todos os campos!');
                    return;
                }

                this.showLoading();

                await supabase
                    .from('rotina_trabalho')
                    .update({
                        horario: horario,
                        etiqueta: etiqueta,
                        cor: cor,
                        tarefas: tarefas
                    })
                    .eq('id', this.editingRotinaId);

                await this.carregarDados();
                this.fecharModalEditarRotina();
                this.hideLoading();
                alert('Bloco de rotina atualizado!');
                this.render();
            }

            async adicionarBlocoRotina() {
                const novaOrdem = Math.max(...this.rotinaTrabalho.map(r => {
                    // Buscar ordem do banco
                    return 0; // Simplificado
                })) + 1;

                this.showLoading();

                await supabase
                    .from('rotina_trabalho')
                    .insert({
                        user_id: this.currentUser.id,
                        ordem: this.rotinaTrabalho.length + 1,
                        horario: '18:00 √†s 19:00',
                        etiqueta: 'Nova Tarefa',
                        cor: 'bg-gray-500',
                        tarefas: ['Adicione suas tarefas aqui']
                    });

                await this.carregarDados();
                this.hideLoading();
                this.render();
            }

            async deletarBlocoRotina(id) {
                if (confirm('Deletar este bloco de rotina?')) {
                    this.showLoading();
                    
                    await supabase
                        .from('rotina_trabalho')
                        .delete()
                        .eq('id', id);

                    await this.carregarDados();
                    this.hideLoading();
                    this.render();
                }
            }

            getHistoricoMesAtual() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                return this.historicoDesempenho.filter(h => {
                    const dataHist = new Date(h.data);
                    return dataHist.getMonth() === mesAtual && dataHist.getFullYear() === anoAtual;
                });
            }

            getDicasPersonalizadas() {
                const historicoMes = this.getHistoricoMesAtual();
                if (historicoMes.length === 0) {
                    return {
                        inicio: 'üöÄ Voc√™ est√° come√ßando! Marque suas tarefas diariamente e clique em "Salvar Dia" para acompanhar seu progresso.',
                        dicas: [
                            'Comece marcando as tarefas mais importantes da manh√£',
                            'Use a rotina como guia para n√£o esquecer nenhum cliente',
                            'Ao final do dia, clique em "Salvar Dia" para registrar seu desempenho'
                        ]
                    };
                }

                const mediaPercentual = historicoMes.reduce((sum, h) => sum + h.percentual, 0) / historicoMes.length;
                const tarefasMaisIncompletas = this.analisarTarefasIncompletas(historicoMes);
                
                let mensagemPrincipal = '';
                let dicas = [];

                if (mediaPercentual >= 90) {
                    mensagemPrincipal = 'üèÜ EXCELENTE! Voc√™ est√° com desempenho excepcional! Continue assim!';
                    dicas = [
                        'Voc√™ √© um exemplo de disciplina! Mantenha esse ritmo',
                        'Considere compartilhar suas estrat√©gias com a equipe',
                        'Foque em otimizar o tempo de cada tarefa agora'
                    ];
                } else if (mediaPercentual >= 75) {
                    mensagemPrincipal = 'üëç MUITO BOM! Voc√™ est√° no caminho certo, mas pode melhorar ainda mais!';
                    dicas = [
                        `Aten√ß√£o especial para: ${tarefasMaisIncompletas[0] || 'todas as tarefas'}`,
                        'Tente completar pelo menos 90% das tarefas di√°rias',
                        'Reserve os √∫ltimos 30min do dia para finalizar pend√™ncias'
                    ];
                } else if (mediaPercentual >= 60) {
                    mensagemPrincipal = '‚ö†Ô∏è ATEN√á√ÉO! Seu desempenho est√° abaixo do ideal. Vamos melhorar?';
                    dicas = [
                        `Principais dificuldades em: ${tarefasMaisIncompletas.slice(0, 2).join(', ')}`,
                        'Defina alarmes para cada bloco de hor√°rio',
                        'Comece pelas tarefas mais dif√≠ceis pela manh√£',
                        'Pe√ßa ajuda ao gestor se necess√°rio'
                    ];
                } else {
                    mensagemPrincipal = 'üö® URGENTE! Seu desempenho precisa melhorar imediatamente!';
                    dicas = [
                        'Converse com seu gestor sobre as dificuldades',
                        'Revise sua rotina e ajuste os hor√°rios',
                        'Foque em completar pelo menos 5 tarefas por dia',
                        'Elimine distra√ß√µes durante o expediente',
                        'Considere fazer um checklist f√≠sico tamb√©m'
                    ];
                }

                return { inicio: mensagemPrincipal, dicas };
            }

            analisarTarefasIncompletas(historico) {
                const contagem = {};
                
                historico.forEach(dia => {
                    dia.detalhes.forEach(det => {
                        if (!det.completo) {
                            contagem[det.etiqueta] = (contagem[det.etiqueta] || 0) + 1;
                        }
                    });
                });

                return Object.entries(contagem)
                    .sort((a, b) => b[1] - a[1])
                    .map(([etiqueta, _]) => etiqueta);
            }

            getVendasFiltradas() {
                return this.vendas.filter(v => {
                    const dataVenda = new Date(v.data_confirmacao);
                    const dataInicio = new Date(this.filtroDataInicio);
                    const dataFim = new Date(this.filtroDataFim);
                    dataFim.setHours(23, 59, 59, 999);
                    return dataVenda >= dataInicio && dataVenda <= dataFim;
                });
            }

            exportarExcel() {
                const vendsFiltradas = this.getVendasFiltradas();
                
                const dados = vendsFiltradas.map(v => ({
                    'Tipo Cliente': v.tipo_cliente,
                    'Nome Cliente': v.nome_cliente,
                    'Check-in': v.check_in,
                    'Check-out': v.check_out,
                    'Hotel': v.hotel,
                    'Valor (R$)': v.valor,
                    'Situa√ß√£o': v.situacao,
                    'Agente': v.agente,
                    'Voucher': v.voucher,
                    'Data Confirma√ß√£o': v.data_confirmacao,
                    'Observa√ß√µes': v.observacoes || ''
                }));

                const totalVendido = vendsFiltradas.reduce((sum, v) => sum + parseFloat(v.valor || 0), 0);
                const totalComissao = (totalVendido * this.comissaoPadrao) / 100;

                dados.push({});
                dados.push({ 'Tipo Cliente': 'RESUMO DO PER√çODO' });
                dados.push({ 'Tipo Cliente': 'Total de Vendas', 'Nome Cliente': vendsFiltradas.length });
                dados.push({ 'Tipo Cliente': 'Valor Total (R$)', 'Nome Cliente': totalVendido.toFixed(2) });
                dados.push({ 'Tipo Cliente': `Comiss√£o ${this.comissaoPadrao}% (R$)`, 'Nome Cliente': totalComissao.toFixed(2) });

                const ws = XLSX.utils.json_to_sheet(dados);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Vendas');
                
                XLSX.writeFile(wb, `C&M_Relatorio_Vendas_${new Date().toISOString().split('T')[0]}.xlsx`);
            }

            renderGraficos() {
                setTimeout(() => {
                    this.renderGraficoDesempenho();
                    this.renderGraficoTarefas();
                }, 100);
            }

            renderGraficoDesempenho() {
                const ctx = document.getElementById('graficoDesempenho');
                if (!ctx) return;

                const historicoMes = this.getHistoricoMesAtual();
                const labels = historicoMes.map(h => {
                    const data = new Date(h.data);
                    return `${data.getDate()}/${data.getMonth() + 1}`;
                });
                const dados = historicoMes.map(h => h.percentual);

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Desempenho Di√°rio (%)',
                            data: dados,
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderGraficoTarefas() {
                const ctx = document.getElementById('graficoTarefas');
                if (!ctx) return;

                const historicoMes = this.getHistoricoMesAtual();
                const tarefas = {};

                historicoMes.forEach(dia => {
                    dia.detalhes.forEach(det => {
                        if (!tarefas[det.etiqueta]) {
                            tarefas[det.etiqueta] = { completo: 0, total: 0 };
                        }
                        tarefas[det.etiqueta].total++;
                        if (det.completo) tarefas[det.etiqueta].completo++;
                    });
                });

                const labels = Object.keys(tarefas);
                const percentuais = labels.map(label => {
                    const t = tarefas[label];
                    return Math.round((t.completo / t.total) * 100);
                });

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Taxa de Conclus√£o (%)',
                            data: percentuais,
                            backgroundColor: [
                                '#C8D946',
                                '#4ECDC4',
                                '#F5A623',
                                '#2C5F5D',
                                '#10B981',
                                '#3B82F6',
                                '#EF4444',
                                '#8B5CF6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderLogin() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="min-h-screen bg-cm-escuro flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
                            <div class="flex justify-center mb-8">
                                <div class="flex gap-2">
                                    <div class="w-16 h-20 bg-cm-laranja rounded flex items-center justify-center">
                                        <span class="text-cm-escuro text-4xl font-bold">C</span>
                                    </div>
                                    <div class="w-16 h-20 bg-cm-verde rounded flex items-center justify-center">
                                        <span class="text-cm-escuro text-4xl font-bold">&</span>
                                    </div>
                                    <div class="w-16 h-20 bg-cm-turquesa rounded flex items-center justify-center">
                                        <span class="text-cm-escuro text-4xl font-bold">M</span>
                                    </div>
                                </div>
                            </div>
                            <h1 class="text-2xl font-bold text-center text-cm-escuro mb-2">Controle de Consultor</h1>
                            <p class="text-gray-600 text-center mb-6 text-sm">Parques & Resorts - Sistema Multi-usu√°rio</p>
                            
                            <!-- Abas Login/Registro -->
                            <div class="flex gap-2 mb-6">
                                <button id="btnLogin" onclick="app.mostrarAba('login')" class="flex-1 px-4 py-2 rounded-lg font-semibold bg-cm-turquesa text-white">Login</button>
                                <button id="btnRegistro" onclick="app.mostrarAba('registro')" class="flex-1 px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700">Criar Conta</button>
                            </div>

                            <!-- Formul√°rio de Login -->
                            <div id="formLogin">
                                <input type="email" id="loginEmail" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-cm-turquesa" />
                                <input type="password" id="loginSenha" placeholder="Senha" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-cm-turquesa" />
                                <button onclick="app.fazerLogin(document.getElementById('loginEmail').value, document.getElementById('loginSenha').value)" class="w-full btn-cm text-white py-3 rounded-lg font-semibold transition">Entrar</button>
                            </div>

                            <!-- Formul√°rio de Registro -->
                            <div id="formRegistro" style="display: none;">
                                <input type="text" id="registroNome" placeholder="Nome Completo" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-cm-turquesa" />
                                <input type="email" id="registroEmail" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-cm-turquesa" />
                                <input type="password" id="registroSenha" placeholder="Senha (m√≠nimo 6 caracteres)" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-cm-turquesa" />
                                <button onclick="app.registrarUsuario(document.getElementById('registroNome').value, document.getElementById('registroEmail').value, document.getElementById('registroSenha').value)" class="w-full btn-cm text-white py-3 rounded-lg font-semibold transition">Criar Conta</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            mostrarAba(aba) {
                const btnLogin = document.getElementById('btnLogin');
                const btnRegistro = document.getElementById('btnRegistro');
                const formLogin = document.getElementById('formLogin');
                const formRegistro = document.getElementById('formRegistro');

                if (aba === 'login') {
                    btnLogin.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-cm-turquesa text-white';
                    btnRegistro.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700';
                    formLogin.style.display = 'block';
                    formRegistro.style.display = 'none';
                } else {
                    btnLogin.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700';
                    btnRegistro.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-cm-turquesa text-white';
                    formLogin.style.display = 'none';
                    formRegistro.style.display = 'block';
                }
            }

            render() {
                if (!this.currentUser) {
                    this.renderLogin();
                    return;
                }

                const app = document.getElementById('app');
                let conteudo = '';

                // Determinar o nome do usu√°rio
                const nomeUsuario = this.currentUser.user_metadata?.nome || this.currentUser.email.split('@')[0];

                if (this.currentPage === 'desempenho') {
                    const historicoMes = this.getHistoricoMesAtual();
                    const mediaPercentual = historicoMes.length > 0 
                        ? historicoMes.reduce((sum, h) => sum + h.percentual, 0) / historicoMes.length 
                        : 0;
                    
                    const diasTrabalhados = historicoMes.length;
                    const melhorDia = historicoMes.length > 0 
                        ? historicoMes.reduce((max, h) => h.percentual > max.percentual ? h : max)
                        : null;

                    const dicas = this.getDicasPersonalizadas();

                    conteudo = `
                        <div>
                            <h2 class="text-2xl font-bold mb-6 text-cm-escuro">üìä Dashboard de Desempenho</h2>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <div class="bg-white p-6 rounded-lg shadow border-t-4 border-cm-laranja">
                                    <p class="text-gray-600 text-sm">Desempenho M√©dio</p>
                                    <p class="text-4xl font-bold text-cm-escuro">${mediaPercentual.toFixed(0)}%</p>
                                    <p class="text-xs text-gray-500 mt-2">Este m√™s</p>
                                </div>
                                <div class="bg-white p-6 rounded-lg shadow border-t-4 border-cm-verde">
                                    <p class="text-gray-600 text-sm">Dias Trabalhados</p>
                                    <p class="text-4xl font-bold text-cm-escuro">${diasTrabalhados}</p>
                                    <p class="text-xs text-gray-500 mt-2">Registrados no sistema</p>
                                </div>
                                <div class="bg-white p-6 rounded-lg shadow border-t-4 border-cm-turquesa">
                                    <p class="text-gray-600 text-sm">Melhor Dia</p>
                                    <p class="text-4xl font-bold text-cm-escuro">${melhorDia ? melhorDia.percentual + '%' : '--'}</p>
                                    <p class="text-xs text-gray-500 mt-2">${melhorDia ? new Date(melhorDia.data).toLocaleDateString('pt-BR') : 'Nenhum registro'}</p>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-lg shadow mb-8 border-l-4 border-cm-turquesa">
                                <h3 class="text-xl font-bold mb-4 text-cm-escuro">üí° An√°lise e Dicas Personalizadas</h3>
                                <p class="text-lg font-semibold mb-4 text-gray-700">${dicas.inicio}</p>
                                <ul class="space-y-2">
                                    ${dicas.dicas.map(dica => `
                                        <li class="flex items-start gap-3">
                                            <span class="text-cm-verde text-xl">‚úì</span>
                                            <span class="text-gray-700">${dica}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            ${historicoMes.length === 0 ? `
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg shadow mb-8">
                                    <h3 class="text-lg font-bold text-yellow-800 mb-2">‚ö†Ô∏è Como Come√ßar?</h3>
                                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                                        <li>V√° para a aba <strong>"‚úÖ Rotina"</strong></li>
                                        <li>Marque as tarefas que voc√™ completar durante o dia</li>
                                        <li>No final do expediente, clique em <strong>"üíæ Salvar Dia"</strong></li>
                                        <li>Volte aqui para ver seus gr√°ficos e an√°lises!</li>
                                    </ol>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div class="bg-white p-6 rounded-lg shadow">
                                        <h3 class="text-lg font-bold mb-4 text-cm-escuro">Evolu√ß√£o do Desempenho</h3>
                                        <div style="height: 300px;">
                                            <canvas id="graficoDesempenho"></canvas>
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-lg shadow">
                                        <h3 class="text-lg font-bold mb-4 text-cm-escuro">Taxa de Conclus√£o por Tarefa</h3>
                                        <div style="height: 300px;">
                                            <canvas id="graficoTarefas"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-bold mb-4 text-cm-escuro">Hist√≥rico Detalhado do M√™s</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-cm-escuro text-white">
                                                <tr>
                                                    <th class="px-4 py-2 text-left">Data</th>
                                                    <th class="px-4 py-2 text-left">Completas</th>
                                                    <th class="px-4 py-2 text-left">Total</th>
                                                    <th class="px-4 py-2 text-left">Desempenho</th>
                                                    <th class="px-4 py-2 text-left">Avalia√ß√£o</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${historicoMes.sort((a, b) => new Date(b.data) - new Date(a.data)).map((h, i) => `
                                                    <tr class="border-b ${i % 2 === 0 ? 'bg-gray-50' : ''}">
                                                        <td class="px-4 py-2 font-semibold">${new Date(h.data).toLocaleDateString('pt-BR')}</td>
                                                        <td class="px-4 py-2">${h.tarefas_completas}</td>
                                                        <td class="px-4 py-2">${h.total_tarefas}</td>
                                                        <td class="px-4 py-2">
                                                            <div class="flex items-center gap-2">
                                                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                                                    <div class="bg-cm-verde h-2 rounded-full" style="width: ${h.percentual}%"></div>
                                                                </div>
                                                                <span class="font-bold text-cm-escuro">${h.percentual}%</span>
                                                            </div>
                                                        </td>
                                                        <td class="px-4 py-2">
                                                            ${h.percentual >= 90 ? 'üèÜ Excelente' : 
                                                              h.percentual >= 75 ? 'üëç Bom' : 
                                                              h.percentual >= 60 ? '‚ö†Ô∏è Regular' : 
                                                              'üö® Fraco'}
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `}
                        </div>
                    `;

                    if (historicoMes.length > 0) {
                        this.renderGraficos();
                    }
                }

                else if (this.currentPage === 'rotina') {
                    const tarefasCompletas = this.rotinaTrabalho.filter(t => t.completo).length;
                    const totalTarefas = this.rotinaTrabalho.length;
                    const percentualCompleto = totalTarefas > 0 ? Math.round((tarefasCompletas / totalTarefas) * 100) : 0;

                    conteudo = `
                        <div>
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-cm-escuro">‚úÖ Rotina de Trabalho</h2>
                                <div class="flex gap-2">
                                    <button onclick="app.salvarDiaNoHistorico()" class="bg-cm-laranja hover:opacity-90 text-white px-4 py-2 rounded-lg font-semibold">üíæ Salvar Dia</button>
                                    <button onclick="app.adicionarBlocoRotina()" class="bg-cm-verde hover:opacity-90 text-cm-escuro px-4 py-2 rounded-lg font-semibold">‚ûï Adicionar</button>
                                    <button onclick="app.resetarRotina()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">üîÑ Resetar</button>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold text-cm-escuro">Progresso do Dia</h3>
                                    <span class="text-2xl font-bold text-cm-turquesa">${percentualCompleto}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div class="bg-cm-verde h-4 rounded-full transition-all duration-500" style="width: ${percentualCompleto}%"></div>
                                </div>
                                <p class="text-gray-600 text-sm mt-2">${tarefasCompletas} de ${totalTarefas} blocos completados</p>
                                <p class="text-xs text-orange-600 mt-3">üí° Ao final do dia, clique em "üíæ Salvar Dia" para registrar seu desempenho!</p>
                            </div>

                            <div class="grid grid-cols-1 gap-4">
                                ${this.rotinaTrabalho.map(item => `
                                    <div class="bg-white rounded-lg shadow-lg overflow-hidden ${item.completo ? 'opacity-75' : ''}">
                                        <div class="${item.cor} text-white p-4 flex justify-between items-center">
                                            <div>
                                                <h3 class="text-xl font-bold">${item.horario}</h3>
                                                <p class="text-sm opacity-90">${item.etiqueta}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="app.abrirModalEditarRotina(${item.id})" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded transition" title="Editar">
                                                    ‚úèÔ∏è
                                                </button>
                                                <button onclick="app.deletarBlocoRotina(${item.id})" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded transition" title="Deletar">
                                                    üóëÔ∏è
                                                </button>
                                                <button onclick="app.toggleTarefaCompleta(${item.id})" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded transition">
                                                    ${item.completo ? '‚úÖ' : '‚≠ï'}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="p-4">
                                            <h4 class="font-bold mb-3 text-gray-700">O que fazer:</h4>
                                            <ul class="space-y-2">
                                                ${item.tarefas.map(tarefa => `
                                                    <li class="flex items-start gap-2">
                                                        <span class="text-cm-turquesa font-bold">‚Ä¢</span>
                                                        <span class="${item.completo ? 'line-through text-gray-400' : 'text-gray-700'}">${tarefa}</span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div id="modalEditarRotina" class="modal">
                            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl m-4">
                                <h3 class="text-xl font-bold text-cm-escuro mb-4">‚úèÔ∏è Editar Bloco de Rotina</h3>
                                ${this.editingRotinaId ? (() => {
                                    const item = this.rotinaTrabalho.find(r => r.id === this.editingRotinaId);
                                    return `
                                        <div class="grid gap-4">
                                            <div>
                                                <label class="block text-sm font-semibold mb-2 text-cm-escuro">Hor√°rio</label>
                                                <input type="text" id="editHorario" value="${item.horario}" placeholder="Ex: 08:00 √†s 08:30" class="w-full px-4 py-2 border rounded-lg focus:border-cm-turquesa" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold mb-2 text-cm-escuro">Nome da Etiqueta</label>
                                                <input type="text" id="editEtiqueta" value="${item.etiqueta}" placeholder="Ex: Atendimento" class="w-full px-4 py-2 border rounded-lg focus:border-cm-turquesa" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold mb-2 text-cm-escuro">Cor do Card</label>
                                                <select id="editCor" class="w-full px-4 py-2 border rounded-lg focus:border-cm-turquesa">
                                                    <option value="bg-green-500" ${item.cor === 'bg-green-500' ? 'selected' : ''}>üü¢ Verde</option>
                                                    <option value="bg-blue-500" ${item.cor === 'bg-blue-500' ? 'selected' : ''}>üîµ Azul</option>
                                                    <option value="bg-red-500" ${item.cor === 'bg-red-500' ? 'selected' : ''}>üî¥ Vermelho</option>
                                                    <option value="bg-yellow-500" ${item.cor === 'bg-yellow-500' ? 'selected' : ''}>üü° Amarelo</option>
                                                    <option value="bg-purple-500" ${item.cor === 'bg-purple-500' ? 'selected' : ''}>üü£ Roxo</option>
                                                    <option value="bg-orange-500" ${item.cor === 'bg-orange-500' ? 'selected' : ''}>üü† Laranja</option>
                                                    <option value="bg-pink-500" ${item.cor === 'bg-pink-500' ? 'selected' : ''}>ü©∑ Rosa</option>
                                                    <option value="bg-gray-500" ${item.cor === 'bg-gray-500' ? 'selected' : ''}>‚ö´ Cinza</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold mb-2 text-cm-escuro">Tarefas (uma por linha)</label>
                                                <textarea id="editTarefas" rows="6" class="w-full px-4 py-2 border rounded-lg focus:border-cm-turquesa">${item.tarefas.join('\n')}</textarea>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 mt-6">
                                            <button onclick="app.salvarEdicaoRotina()" class="flex-1 btn-cm text-white py-3 rounded-lg font-semibold">üíæ Salvar</button>
                                            <button onclick="app.fecharModalEditarRotina()" class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold">‚ùå Cancelar</button>
                                        </div>
                                    `;
                                })() : ''}
                            </div>
                        </div>
                    `;
                }

                else if (this.currentPage === 'vendas') {
                    conteudo = `
                        <div>
                            <h2 class="text-2xl font-bold mb-6 text-cm-escuro">üé´ Gerenciar Reservas</h2>
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6">
                                <p class="text-yellow-800">üöß M√≥dulo de vendas ser√° implementado em breve com integra√ß√£o Supabase.</p>
                            </div>
                        </div>
                    `;
                }

                else if (this.currentPage === 'dashboard') {
                    conteudo = `
                        <div>
                            <h2 class="text-2xl font-bold mb-6 text-cm-escuro">üí∞ Dashboard de Vendas</h2>
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6">
                                <p class="text-yellow-800">üöß Dashboard de vendas ser√° implementado em breve.</p>
                            </div>
                        </div>
                    `;
                }

                else if (this.currentPage === 'config') {
                    conteudo = `
                        <div>
                            <h2 class="text-2xl font-bold mb-6 text-cm-escuro">üîß Configura√ß√µes</h2>
                            <div class="bg-white p-6 rounded-lg shadow max-w-md">
                                <h3 class="text-xl font-bold mb-4 text-cm-escuro">Informa√ß√µes da Conta</h3>
                                <p class="text-gray-600 mb-2"><strong>Email:</strong> ${this.currentUser.email}</p>
                                <p class="text-gray-600 mb-6"><strong>Nome:</strong> ${nomeUsuario}</p>
                                
                                <h3 class="text-xl font-bold mb-4 text-cm-escuro mt-8">Dados do Sistema</h3>
                                <p class="text-gray-600 mb-4">Blocos de rotina: <strong>${this.rotinaTrabalho.length}</strong></p>
                                <p class="text-gray-600 mb-4">Hist√≥rico de dias: <strong>${this.historicoDesempenho.length}</strong></p>
                                
                                <button onclick="app.logout()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-semibold mt-8">
                                    üö™ Sair da Conta
                                </button>
                            </div>
                        </div>
                    `;
                }

                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50">
                        <div class="bg-cm-escuro text-white shadow-lg">
                            <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <div class="flex gap-1">
                                        <div class="w-8 h-10 bg-cm-laranja rounded flex items-center justify-center">
                                            <span class="text-cm-escuro text-xl font-bold">C</span>
                                        </div>
                                        <div class="w-8 h-10 bg-cm-verde rounded flex items-center justify-center">
                                            <span class="text-cm-escuro text-xl font-bold">&</span>
                                        </div>
                                        <div class="w-8 h-10 bg-cm-turquesa rounded flex items-center justify-center">
                                            <span class="text-cm-escuro text-xl font-bold">M</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-bold">Controle de Consultor</h1>
                                        <p class="text-xs text-gray-300">Ol√°, ${nomeUsuario}!</p>
                                    </div>
                                </div>
                                <button onclick="app.logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm">üö™ Sair</button>
                            </div>
                        </div>

                        <div class="bg-white shadow border-b">
                            <div class="max-w-6xl mx-auto flex gap-4 px-4 py-3 overflow-x-auto">
                                <button onclick="app.currentPage = 'desempenho'; app.render();" class="px-4 py-2 rounded-lg whitespace-nowrap font-semibold ${this.currentPage === 'desempenho' ? 'bg-cm-turquesa text-white' : 'bg-gray-200 text-gray-700'}">üìä Desempenho</button>
                                <button onclick="app.currentPage = 'rotina'; app.render();" class="px-4 py-2 rounded-lg whitespace-nowrap font-semibold ${this.currentPage === 'rotina' ? 'bg-cm-turquesa text-white' : 'bg-gray-200 text-gray-700'}">‚úÖ Rotina</button>
                                <button onclick="app.currentPage = 'dashboard'; app.render();" class="px-4 py-2 rounded-lg whitespace-nowrap font-semibold ${this.currentPage === 'dashboard' ? 'bg-cm-turquesa text-white' : 'bg-gray-200 text-gray-700'}">üí∞ Vendas</button>
                                <button onclick="app.currentPage = 'vendas'; app.render();" class="px-4 py-2 rounded-lg whitespace-nowrap font-semibold ${this.currentPage === 'vendas' ? 'bg-cm-turquesa text-white' : 'bg-gray-200 text-gray-700'}">üé´ Reservas</button>
                                <button onclick="app.currentPage = 'config'; app.render();" class="px-4 py-2 rounded-lg whitespace-nowrap font-semibold ${this.currentPage === 'config' ? 'bg-cm-turquesa text-white' : 'bg-gray-200 text-gray-700'}">üîß Config</button>
                            </div>
                        </div>

                        <div class="max-w-6xl mx-auto px-4 py-8">
                            ${conteudo}
                        </div>
                    </div>
                `;
            }
        }

        const app = new ControlConsultor();
    </script>
</body>
</html>
